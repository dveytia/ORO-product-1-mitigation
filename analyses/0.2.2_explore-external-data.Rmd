---
title: "0.2_explore-external-data"
author: "Devi Veytia"
date: "2024-04-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load libraries}
library(dplyr)
library(ggplot2)
library(sf)
library(rnaturalearth)
library(egg)
#countries <- map_data("world")

## Source functions
source(here::here("R/Display_color_scales.R"))
```

```{r method 1 to get robinson projection too much fuss, eval = FALSE}
# Get a robinson projection as well
# hack from: https://stackoverflow.com/questions/56146735/visual-bug-when-changing-robinson-projections-central-meridian-with-ggplot2/56155662#56155662
world <- ne_countries(scale = "large", returnclass = "sf")
polygon <- st_polygon(x = list(rbind(c(-0.0001, 90),
                                     c(0, 90),
                                     c(0, -90),
                                     c(-0.0001, -90),
                                     c(-0.0001, 90)))) %>%
  st_sfc() %>%
  st_set_crs(4326)
# modify world dataset to remove overlapping portions with world's polygons
sf_use_s2(FALSE)
world2 <- world %>% st_difference(polygon)
# perform transformation on modified version of world dataset
world_robinson <- st_transform(world2, 
                               crs = '+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs'
                               )
# dirty fix for error with geom_map
obj_is_vector = function(x){TRUE} 



```

```{r method 2 to get robinson projection}
# Download countries polygons
world_robinson <- ne_countries(type = "countries", 
                   scale = "medium",
                   returnclass = "sf") |>
  # transform to desired projection
  st_transform("ESRI:54030")
# This is a dummy column used to fill in mean values
world_robinson$value <- rnorm(242,0.5,0.1)

# Make plot
world_robinson |>
  ggplot(aes(fill = value, color = value)) +
  geom_sf() +
  coord_sf(expand = FALSE)

```

# Marine renewable energy


## IRENA renewable electricity statistics

This database presents statistics aggregated by country, technology, data type, grid connection, year. Data downloaded from: https://pxweb.irena.org/pxweb/en/IRENASTAT

```{r plot deployment data from IRENA renewable energy statistics}
df <- readxl::read_excel(here::here("data/raw-data/external/IRENA-electricity-statistics-by-country-year.xlsx"),
                         sheet = "ELECSTAT-C", col_names = FALSE, skip = 2)
colnames(df) <- c("country","technology","data_type","grid_connection","year","value")

df <- df %>% 
  tidyr::fill(country, technology, data_type, data_type, grid_connection, .direction = "down")

# filter data to one variable, all grid connections
df <- df %>%
  filter(data_type == "Electricity Installed Capacity (MW)", grid_connection == "All", technology %in% c("Marine energy","Offshore wind energy")) 

# Format columns
df$year <- as.Date(paste0(df$year,"-01-01"))

# plot of time series
mre_installedCapacityTimeseries_ggp <- df %>%
  group_by(year) %>%
  summarise(installed_capacity = sum(value, na.rm=T)) %>%
  ggplot(aes(year, installed_capacity))+
  geom_area(alpha=0.5)+
  labs(y = "Electricity Installed Capacity (MW)", x= "Year",
       caption = "annual value comprises marine energy and offshore wind, for all countries\n Data source: IRENA renewable electricity statistics (https://pxweb.irena.org/pxweb/en/IRENASTAT)")+
  scale_x_date()+
  theme_bw()+
  theme(legend.position = 'none')
mre_installedCapacityTimeseries_ggp

# Map by country
df2 <- df %>%
  group_by(country) %>%
  summarise(installed_capacity = sum(value, na.rm=T)) %>%
  mutate(iso_n3 = as.character(countrycode(country, origin = "country.name", destination = "iso3n")))
df2 <- merge(world_robinson, df2, by = "iso_n3", all.x = TRUE)

# exponential colour scale
brks = seq(min(df2$installed_capacity), max(df2$installed_capacity), length.out = 15)
a=1
b= 1.5
vals = scales::rescale(a*(b^(1:length(brks))), to = c(0,1))
#plot(vals)

# plot
mre_installedCapacityCountryCumulative_ggp <- df2 |>
  ggplot(aes(fill = installed_capacity, color = installed_capacity)) +
  geom_sf() +
  coord_sf(expand = FALSE)+
  scale_fill_viridis_c(values = vals)+
  scale_color_viridis_c(values = vals)+
  labs(fill = "",color = "")+
  # scale_fill_stepsn(breaks = brks, colors = viridis::viridis(length(brks)),
  #                   values = vals)+
  # scale_color_stepsn(breaks = brks, colors = viridis::viridis(length(brks)),
  #                    values = vals)+
  theme(legend.position = "bottom")

mre_installedCapacityCountryCumulative_ggp


# Plot together

mre_plots <- ggarrange(
  plots = list(
    mre_installedCapacityCountryCumulative_ggp + 
      theme(plot.margin=unit(c(1,0.5,0.5,0.1), 'cm')), 
    mre_installedCapacityTimeseries_ggp), nrow=1, widths = c(3.5,3), 
          labels = c("a. MRE installed capacity (2000 - 2023)", "b. Global annual MRE installed capacity"),
          label.args = list(gp = grid::gpar(font = 4, cex = 1.2)),
          newpage = FALSE, draw=FALSE)



ggsave(here::here("figures/2024-07-01_expert-panel-meeting/MRE_deployment_figures.pdf"),
       mre_plots, height = 5, width = 12, units = 'in')




## which country is responsible for jump in 2010?
# subset to just the highest countries
top_countries <- df %>%
  group_by(country) %>%
  summarise(installed_capacity = sum(value, na.rm=T)) %>%
  arrange(desc(installed_capacity)) %>%
  head(5) 

df3 <- df[which(df$country %in% top_countries$country),]
df3$country <- countrycode(df3$country, origin = "country.name", destination = "country.name")

mre_installedCapacityTimeseriesTopCountries_ggp <-  df3 %>%
  group_by(year, country) %>%
  summarise(installed_capacity = sum(value, na.rm=T)) %>%
  ggplot(aes(year, installed_capacity, fill = country, colour = country))+
  geom_area(alpha=0.5)+
  labs(y = "Electricity Installed Capacity (MW)", 
       x= "Year")+
  scale_x_date()+
  theme_bw()+
  theme(legend.position = "bottom")+guides(fill=guide_legend(nrow=2,byrow=TRUE))

mre_installedCapacityTimeseriesTopCountries_ggp




## which technology is responsible for jump in 2010?
# subset to just the highest countries
mre_installedCapacityTimeseriesTechnology_ggp <- df %>%
  group_by(year, technology) %>%
  summarise(installed_capacity = sum(value, na.rm=T)) %>%
  ggplot(aes(year, installed_capacity, fill = technology, colour = technology))+
  geom_area(alpha=0.5)+
  labs(y = "Electricity Installed Capacity (MW)", 
       x= "Year")+
  scale_x_date()+
  theme_bw()+
  theme(legend.position = "bottom",
        plot.margin=unit(c(1,0,0,0), 'cm'))



## Just do an inset of Marine energy by country
top_countries_me <- df %>%
  filter(technology == "Marine energy") %>%
  group_by(country) %>%
  summarise(installed_capacity = sum(value, na.rm=T)) %>%
  arrange(desc(installed_capacity)) %>%
  head(5) 

df4 <- df[which(df$country %in% top_countries_me$country),]
df4$country <- countrycode(df4$country, origin = "country.name", destination = "country.name")

mre_installedCapacityTimeseriesTopCountriesMarineEnergy_ggp <-  df4 %>%
  group_by(year, country) %>%
  summarise(installed_capacity = sum(value, na.rm=T)) %>%
  ggplot(aes(year, installed_capacity, fill = country))+
  geom_area(alpha=0.5)+
  labs(y = "", 
       x= "")+
  scale_x_date()+
  theme_bw()+
  theme(
    legend.position = "bottom",
    legend.title = element_text(size=7),
    legend.text = element_text(size=7),
    legend.key.size = unit(0.5, units="cm"),
    axis.title = element_text(size=5),
    axis.text = element_text(size=4)
    )+
  guides(fill=guide_legend(nrow=2,byrow=TRUE))



# library(cowplot)
# 
# plotwithinset <- ggdraw()+
#   draw_plot(mre_installedCapacityTimeseriesTechnology_ggp+
#               theme(plot.margin=unit(c(0,0,0,0), 'cm')))+
#   draw_plot(mre_installedCapacityTimeseriesTopCountriesMarineEnergy_ggp+
#               theme(plot.margin=unit(c(0,0,0,0), 'cm')),
#             x=0.15,y=0.45,width = 0.4, height = 0.5)
# plotwithinset


plotwithinset2 <- mre_installedCapacityTimeseriesTechnology_ggp+
  annotation_custom(
    ggplotGrob(mre_installedCapacityTimeseriesTopCountriesMarineEnergy_ggp), 
    xmin = -Inf, xmax = as.Date("2015-01-01"), ymin = 15000, ymax = Inf
  )


## ARRANGE TOGETHER
mre_plots <- ggarrange(
  plots = list(
    mre_installedCapacityTimeseries_ggp+ 
      theme(plot.margin=unit(c(1,0.5,0.5,0.1), 'cm')),
    mre_installedCapacityTimeseriesTopCountries_ggp+ 
      theme(plot.margin=unit(c(1,0.5,0.5,0.1), 'cm')),
    plotwithinset2+
      theme(plot.margin=unit(c(1,0.5,0.5,0.1), 'cm')),
    mre_installedCapacityCountryCumulative_ggp + 
      theme(plot.margin=unit(c(1,0.5,0.5,0.1), 'cm'))
    ),
  nrow=2, 
  labels = c("a. Global annual MRE installed capacity", 
             "b. Top 5 countries",
             "c. By technology",
             "d. MRE installed capacity (2000 - 2023)"
             ),
          label.args = list(gp = grid::gpar(font = 4, cex = 1.2)),
          newpage = FALSE, draw=FALSE)



ggsave(here::here("figures/2024-07-01_expert-panel-meeting/MRE_deployment_figures.pdf"),
       mre_plots, height = 10, width = 12, units = 'in')

```

## 4 C Offshore?


# Increasing efficiency

``````{r load in total volume datasets i.e. tonnes}

# OECD Annual container transport (tonnes) 
# https://data-explorer.oecd.org/vis?df[ds]=dsDisseminateFinalDMZ&df[id]=DSD_TRENDS%40DF_TRENDSCONT&df[ag]=OECD.ITF&df[vs]=1.0&lo=5&lom=LASTNPERIODS&dq=.A.....&to[TIME_PERIOD]=false
oecd_container_transport <- read.csv(
  here::here("data/raw-data/external/OECD_annual_container_transport.csv")
)
oecd_container_transport <- oecd_container_transport %>%
  filter(Transport.mode == "Maritime") %>%
  mutate(
    country = Reference.area,
    country_code = countrycode::countrycode(Reference.area, origin = "country.name",
                          destination = "country.name"),
    vehicle_type = "All ships",
    product = "Container transport (Tonnes)",
    year = as.Date(paste0(TIME_PERIOD,"-01-01")),
    value = OBS_VALUE #*0.907185 # Convert Tonnes to Mt?
    ) %>%
  filter(!is.na(year)) %>% # NA values are yearly totals
  select(country,country_code, vehicle_type, product, year, value)
oecd_container_transport$dataset <- paste("OECD container transport")


# OECD Annual transport trends (tonnes)
# https://data-explorer.oecd.org/vis?tm=ship&pg=0&snb=24&df[ds]=dsDisseminateFinalDMZ&df[id]=DSD_TRENDS%40DF_TRENDS&df[ag]=OECD.ITF&df[vs]=1.0&pd=1970%2C2022&dq=.A.CONTAINER%2BFREIGHT.TKM%2BT.COASTAL%2BMAR..&ly[rw]=REF_AREA&ly[cl]=TIME_PERIOD&ly[rs]=MEASURE%2CUNIT_MEASURE&to[TIME_PERIOD]=false
oecd_transport_trends <- read.csv(
  here::here("data/raw-data/external/OECD_annual_transport_trends.csv")
)
oecd_transport_trends <- oecd_transport_trends %>%
  mutate(
    country = Reference.area,
    country_code = countrycode::countrycode(Reference.area, origin = "country.name",
                          destination = "country.name"),
    vehicle_type = gsub(" transport","",Measure),
    product = "Transport (Tonnes)",
    year = as.Date(paste0(TIME_PERIOD,"-01-01")),
    value = OBS_VALUE 
    ) %>%
  filter(!is.na(year)) %>% # NA values are yearly totals
  select(country,country_code, vehicle_type, product, year, value)
oecd_transport_trends$dataset <- paste("OECD transport trends")
# get world total
oecd_transport_trends_global <- oecd_transport_trends %>%
  group_by(vehicle_type, product, year) %>%
  summarise(value = sum(value)) %>%
  mutate(country = "World")


# World bank capture fisheries production (tonnes)
# https://data.worldbank.org/indicator/ER.FSH.CAPT.MT
wb_capture_fisheries <- readxl::read_excel(
  here::here("data/raw-data/external/The-World-Bank_Data_Extract_From_World_Development_Indicators.xlsx"), sheet = "Data"
)
wb_capture_fisheries <- wb_capture_fisheries %>%
  filter(`Series Name` == "Capture fisheries production (metric tons)") %>%
  mutate(country = `Country Name`,
         country_code = countrycode::countrycode(`Country Name`, 
                                                 origin = "country.name",
                          destination = "country.name"),
         vehicle_type = "Capture fisheries",
         product = "Fisheries production (metric tons)") 
# Format column names into Year and melt into long form
colnames(wb_capture_fisheries)[5:68] <- as.integer(
  substr(
    colnames(wb_capture_fisheries)[5:68], 
    1, 4))
wb_capture_fisheries <- reshape2::melt(
  wb_capture_fisheries,
  id.vars = c("Series Name", "Series Code","Country Name",
              "Country Code","country","country_code","vehicle_type","product"),
  variable.name = "year"
)
wb_capture_fisheries <- wb_capture_fisheries %>%
  select(country,country_code, vehicle_type, product, year, value)
wb_capture_fisheries$year <- as.Date(paste0(wb_capture_fisheries$year,"-01-01"))
wb_capture_fisheries$value <- as.numeric(wb_capture_fisheries$value)
# Subset to just global sums
wb_capture_fisheries_global <- wb_capture_fisheries %>%
  filter(country == "World")





## Plot and scale on second axis
source(here::here("R/my_sec_axis_lineplot.R"))

# Set color scale
volume_col_brks <- c("Capture fisheries","Container","Freight")
volume_col_labs <- c("Fisheries","Shipping:\ncontainer","Shipping:\nFreight")
volume_col_pal <- Tol_muted[c(2,7,8)]
# Format data for functoin
dat1 <- oecd_transport_trends_global %>%
  rename(x_axis = year, col_var = vehicle_type)
dat2 <- wb_capture_fisheries_global %>%
  rename(x_axis = year, col_var = vehicle_type)
# Plot using function
all_volume_global_ggp <- my_sec_axis_lineplot(dat.prim = dat1, dat.sec = dat2, name.prim = "Fisheries production\n(metric tons)", name.sec = "Maritime transport\n(Tonnes)",lwd = 1)
# Add additional aesthetics
all_volume_global_ggp <- all_volume_global_ggp+
  scale_x_date("Year") +
  scale_color_manual(name="Sector",values = volume_col_pal, breaks = volume_col_brks, labels = volume_col_labs)+
  labs(caption = "Data sources:\nWorld bank capture fisheries production (tonnes)\nOECD Annual transport trends")+
  theme(
    legend.position = "bottom"
  )
all_volume_global_ggp
  

```



```{r load in total emissions datasets}

# IEA domestic transport total emissions
domestic_shipping_emissions <- readxl::read_excel(here::here("data/raw-data/external/IEA-Energy-End-uses-and-Efficiency-Indicators-database-Highlights-November-2023.xlsx"), sheet = "Transport - Emissions")
colnames(domestic_shipping_emissions) <- c("country","vehicle_type","product","2000","2005","2010","2015","2016","2017","2018","2019","2020","2021")
# Filter out Road, train and air transport
domestic_shipping_emissions <- domestic_shipping_emissions %>%
  filter(vehicle_type == "Total ships") %>%
  mutate(vehicle_type = gsub("Total ships","Total domestic ships", vehicle_type))
# reshape to long form
domestic_shipping_emissions <- reshape2::melt(
  domestic_shipping_emissions, 
  measure.vars = c("2000","2005","2010","2015","2016","2017","2018","2019","2020","2021"),
  variable.name = "year",
  value.name = "value")
# Format columns
domestic_shipping_emissions$year <- as.Date(
  paste0(domestic_shipping_emissions$year,"-01-01"))
domestic_shipping_emissions$value <- as.numeric(
  domestic_shipping_emissions$value)
domestic_shipping_emissions$country_code <- countrycode::countrycode(
  domestic_shipping_emissions$country, origin = "country.name",
  destination = "country.name"
)
domestic_shipping_emissions <- domestic_shipping_emissions %>%
  select(country,country_code, vehicle_type, product, year, value)
domestic_shipping_emissions$dataset <- paste("IEA domestic transport")



# OECD Maritime transport CO2 emissions
# https://data-explorer.oecd.org/vis?tm=ship&pg=0&snb=24&df[ds]=dsDisseminateFinalDMZ&df[id]=DSD_MARITIME_TRANSPORT%40DF_MARITIME_TRANSPORT&df[ag]=OECD.SDD.NAD.SEEA&df[vs]=1.0&pd=2022-01%2C&dq=.M......ALL_VESSELS&ly[rw]=REF_AREA&ly[cl]=TIME_PERIOD&to[TIME_PERIOD]=false
oecd_maritime_emissions <- read.csv(
  here::here("data/raw-data/external/OECD_maritime-transport-CO2-emissions.csv")
)
# Format columns
oecd_maritime_emissions <- oecd_maritime_emissions %>%
  mutate(
    country = Reference.area,
    country_code = countrycode::countrycode(Reference.area, origin = "country.name",
                          destination = "country.name"),
    vehicle_type = gsub("All vessels","Total ships", Vessel),
    product = "Total final emissions (MtCO2)",
    year = as.Date(paste0(TIME_PERIOD,"-01")),
    value = OBS_VALUE/1000000 #*0.907185 # Convert Tonnes to Mt?
    ) %>%
  filter(!is.na(year)) %>% # NA values are yearly totals
  select(country,country_code, vehicle_type, product, year, value)
oecd_maritime_emissions$dataset <- paste("OECD maritime emissions")

# Fishing total emissions - Greer et al 2019 Fig 2



## Combine emissions datasets
all_emissions_df <- rbind(
  domestic_shipping_emissions,
  oecd_maritime_emissions
)
# Group all countries together to get wold value
all_emissions_global_df <- all_emissions_df %>%
  filter(country %in% c("IEA Total", "World") &
           vehicle_type %in% c("Total domestic ships", "Total ships"))

# Set colors
emis_col_brks <- c("IEA domestic transport","OECD maritime emissions")
emis_col_labs <- c("Shipping:\nDomestic","Shipping:\nAll maritime")
emis_col_pal <- Tol_muted[c(7,8)]

# Plot
all_emissions_global_ggp <- ggplot(all_emissions_global_df, aes(x=year, y = value))+
  geom_line(aes(color = dataset), linewidth = 1) +
  scale_x_date(name = "Year", limits = as.Date(c("1960-01-01","2023-01-01")))+
  scale_color_manual(name = "Sector", values = emis_col_pal, breaks = emis_col_brks, labels = emis_col_labs)+
  labs(
    y = "Mt CO2",
    color = "Sector",
    caption = "Data Source:\nAll maritime: OECD Maritime transport CO2 emissions\n(breakdown by vessel type available,\ntransformed Tonnes to Mt by dividing by 1,000,000)\nDomestic: IEA Energy End uses and Efficiency Indicators Highlights\nMissing Fisheries emissions from Greer et al 2019"
  )+
  theme_bw()+
  theme(
    legend.position = "bottom"
  )

all_emissions_global_ggp

```




```{r load in efficiency datasets}

# Fuel coefficient (engine efficiency) - Greer et al 2019
greer_FC <- readxl::read_excel(here::here("data/raw-data/external/Greer-et-al-2019_fuel-coefficient-table-5.xlsx"), sheet = "fuel_coefficient")
greer_FC <- greer_FC %>%
  mutate(col_var = "Fuel coefficient", x_axis = as.Date(paste0(year, "-01-01"))) %>%
  rename(value=fuel_coefficient)%>%
  select(col_var, x_axis, value)


# IEA domestic freight transport energy efficiency (gCO2/tkm)
# https://www.iea.org/data-and-statistics/data-product/energy-efficiency-indicators
domestic_shipping_efficiency <- readxl::read_excel(here::here("data/raw-data/external/IEA-shipping-energy-efficiency.xlsx"), sheet = "Data")
domestic_shipping_efficiency$year <- as.Date(paste0(domestic_shipping_efficiency$year,"-01-01"))



# Fishing Emissions intensity - Greer et al 2019
# For extraction code using metadigitize see version of file 0.2.1
load(here::here("data/raw-data/external/Greer-et-al-2019_emissions-intensity_industrial.RData"))





## Plot and scale on second axis
source(here::here("R/my_sec_axis_lineplot.R"))

# Set color scale
eff_col_brks <- c("Fishing:\nIndustrial","Shipping:\nDomestic", "Fuel coefficient")
eff_col_labs <- c("Fishing:\nIndustrial","Shipping:\nDomestic","Fuel efficiency\ncoefficient")
eff_col_pal <- Tol_muted[c(2,7,5)]
# Format data for functoin
eff_dat1 <- domestic_shipping_efficiency %>%
  rename(x_axis = year) %>%
  mutate(col_var = "Shipping:\nDomestic", value = 1/carbon_intensity_gCO2_per_tkm) %>%
  arrange(x_axis)
eff_dat2 <- greer_industrial %>%
  mutate(x_axis = as.Date(paste0(round(x),"-01-01")),
         col_var = "Fishing:\nIndustrial", value = 1/y) %>%
  arrange(x_axis)
# Plot using function
all_efficiency_global_ggp <- my_sec_axis_lineplot(dat.prim = eff_dat1, dat.sec = eff_dat2, name.prim = "Shipping efficiency\n(tkm/gCO2)", name.sec = "Fishing efficiency\n(tcatch/tCO2)",lwd = 1)
# Add a lineplot for fuel coefficient
all_efficiency_global_ggp <- all_efficiency_global_ggp +
  geom_line(data = greer_FC, 
            aes(x_axis, scales::rescale(1/value, to = range(eff_dat1$value, na.rm=T)), 
                color = col_var), linewidth = 1)
# Add additional aesthetics
all_efficiency_global_ggp <- all_efficiency_global_ggp +
  scale_x_date("Year",limits = c(as.Date(c("1960-01-01","2023-01-01")))) +
  scale_color_manual(name="Sector",values = eff_col_pal, breaks = eff_col_brks, labels = eff_col_labs)+
  labs(caption = "Data sources:\nDomestic shipping: IEA energy end uses and efficiency indicators database\nFishing (Industrial): Greer et al 2019 Fig 3\nFuel coefficient: inverse of fuel coefficient from Greer et al 2019 Table 5")+
  theme(
    legend.position = "bottom"
  )
all_efficiency_global_ggp

```


```{r combine all increasing efficiency plots}
require(egg)


eff_plots <- ggarrange(
  plots = list(
    all_volume_global_ggp+ 
      theme(plot.margin=unit(c(1,0.5,0.5,0.1), 'cm')),
    all_emissions_global_ggp+ 
      theme(plot.margin=unit(c(1,0.5,0.5,0.1), 'cm')),
    all_efficiency_global_ggp+
      theme(plot.margin=unit(c(1,0.5,0.5,0.1), 'cm'))),
  nrow=3, 
  labels = c("a. Volume indicators", 
             "b. Emissions indicators",
             "c. Efficiency indicators"
             ),
          label.args = list(gp = grid::gpar(font = 4, cex = 1.2)),
          newpage = FALSE, draw=FALSE)



ggsave(here::here("figures/2024-07-01_expert-panel-meeting/Efficiency_deployment_figures.pdf"),
       eff_plots, height = 12, width = 6, units = 'in')
```


# mCDR deployments 

```{r Gattuso 2018 - ocean iron fertilisation experiments km2 - STILL NEED}
oif_df <- readxl::read_excel(here::here("data/raw-data/external/OIF_data.xlsx"))

oif_df <- oif_df %>%
  filter(!is.na(Year)) %>%
  mutate(year = as.Date(paste0(Year,"-01-01"))) %>%
  group_by(year) %>%
  summarise(value = sum(`Total Size`, na.rm=T))


```

```{r State of CDR report - gross removals tCO2 per year}
gross_removals_df <- readxl::read_excel(here::here("data/raw-data/external/State-of-Carbon-Report-2022-Novel-CDR-Deployment-Data.xlsx"), skip = 1)

carbon_sinks <- unique(do.call(c, unique(as.vector(gross_removals_df[,3:6]))))
carbon_sinks

gross_removals_df$carbon_sink <- apply(gross_removals_df[,3:6], 1, paste, collapse=", ")
gross_removals_df <- gross_removals_df %>%
  mutate(ocean = ifelse(
    grepl("Aquatic", carbon_sink) | grepl("Deep Ocean", carbon_sink)| 
      grepl("Dissolved CO2", carbon_sink) | grepl("Bicarbonate", carbon_sink), TRUE,FALSE
  ))
gross_removals_df$year = as.Date(paste0(gross_removals_df$`Year active`,"-01-01")) 

summary(gross_removals_df)

gross_removals_df %>%
  filter(ocean) %>%
  group_by(year) %>%
  summarise(`Gross Removals\n(tCO2/year)` = sum(`Gross Removals\n(tCO2/year)`, na.rm=T)) %>%
  mutate(`Gross Removals\n(tCO2/year)` = cumsum(`Gross Removals\n(tCO2/year)`)) %>%
  ggplot(aes(year, `Gross Removals\n(tCO2/year)`))+
  geom_line()+
  geom_point()+
  scale_x_date()+
  labs(y = "Cumulative Gross Removals\n(tCO2/year)",
       caption = "Source: State of CDR Report 2022 - Novel CDR Deployment Data\nfiltered for where carbon is stored in ocean sinks")+
  theme_bw()
```


```{r State of CDR report - number of active grants - consider removing}
# data downloaded from: https://portal.stateofcdr.org/chapter/2

active_grants_df <- read.csv(here::here("data/raw-data/external/State-of-Carbon-Report-2024_Chatper-2_Number_of_active_grants.csv"))

# Format dataframe into long form, and present metric as total number of projects rather than %
colnames(active_grants_df)[6:28] <- gsub("X","",colnames(active_grants_df)[6:28])
active_grants_df <- active_grants_df %>%
  select(-c(Model, Scenario, Region, Unit))
active_grants_df <- active_grants_df %>%
  filter(Variable %in% c("Research|Removal|Active Grants", "Research|Removal|Active Grants|Coastal Wetland Restoration [Share]", "Research|Removal|Active Grants|Ocean Alkalinity Enhancement [Share]", "Research|Removal|Active Grants|Ocean Fertilization [Share]"))
active_grants_df <- reshape2::melt(active_grants_df, 
                                   id.vars = c("Variable"), 
                                   variable.name = "year", 
                                   value.name = "value")
active_grants_df$year <- as.Date(paste0(active_grants_df$year,"-01-01"))


active_grants_total <- active_grants_df %>%
  filter(Variable == "Research|Removal|Active Grants") %>%
  rename(total_grants = value) %>%
  select(-c(Variable))
active_grants_df <- active_grants_df %>%
  filter(Variable != "Research|Removal|Active Grants") %>%
  left_join(active_grants_total, by = "year") %>%
  mutate(n_grants = value/100*total_grants,
         Variable = factor(Variable, 
                           levels = c("Research|Removal|Active Grants|Coastal Wetland Restoration [Share]", "Research|Removal|Active Grants|Ocean Alkalinity Enhancement [Share]", "Research|Removal|Active Grants|Ocean Fertilization [Share]"),
                           labels = c("Coastal Wetland Restoration", "Ocean Alkalinity Enhancement", "Ocean Fertilization"))) %>%
  select(-c(value, total_grants)) %>%
  rename(value = n_grants)
  
  
head(active_grants_df)
```


```{r State of CDR report - number of patents}
# data downloaded from: https://portal.stateofcdr.org/chapter/2

patents_df <- read.csv(here::here("data/raw-data/external/State-of-Carbon-Report-2024_Chatper-2_Number_of_patents.csv"))

# Format dataframe into long form
colnames(patents_df)[6:28] <- gsub("X","",colnames(patents_df)[6:28])
patents_df <- patents_df %>%
  select(-c(Model, Scenario, Region, Unit))

patents_df <- patents_df %>%
  filter(Variable %in% c("Research|Removal|Patents|Coastal Wetland Restoration", "Research|Removal|Patents|Ocean Alkalinity Enhancement","Research|Removal|Patents|Ocean Fertilization"))

patents_df <- reshape2::melt(patents_df, 
                                   id.vars = c("Variable"), 
                                   variable.name = "year", 
                                   value.name = "value")
patents_df$year <- as.Date(paste0(patents_df$year,"-01-01"))

patents_df <- patents_df %>%
  mutate(Variable = factor(Variable, 
                           levels = c("Research|Removal|Patents|Coastal Wetland Restoration", "Research|Removal|Patents|Ocean Alkalinity Enhancement","Research|Removal|Patents|Ocean Fertilization"),
                           labels = c("Coastal Wetland Restoration", "Ocean Alkalinity Enhancement", "Ocean Fertilization")))
  
  
head(patents_df)
```

```{r State of CDR report - investment in startups}
# # https://portal.stateofcdr.org/chapter/3
# # CDR start-ups are defined here as start-ups related to the capture of CO₂ from the atmosphere. This analysis examines the state of investments in CDR start-ups through December 31, 2023, using the Net-Zero Insights (NZI) database, which contains a total of 509 CDR start-ups.
# 
# startups_df <- read.csv(here::here("data/raw-data/external/State-of-Carbon-Report-2024_Chatper-3_Number_of_startups.csv"))
# 
# # Format dataframe into long form
# colnames(startups_df)[6:20] <- gsub("X","",colnames(startups_df)[6:20])
# startups_df <- startups_df %>%
#   select(-c(Model, Scenario, Region, Unit))
# 
# startups_df <- startups_df %>%
#   filter(Variable %in% c("Start-Up|Removal|Number of Firms|Direct Ocean Capture", "Start-Up|Removal|Number of Firms|Ocean Alkalinity Enhancement"))
# 
# startups_df <- reshape2::melt(startups_df, 
#                                    id.vars = c("Variable"), 
#                                    variable.name = "year", 
#                                    value.name = "value")
# startups_df$year <- as.Date(paste0(startups_df$year,"-01-01"))
# 
# startups_df <- startups_df %>%
#   mutate(Variable = factor(Variable, 
#                            levels = c("Start-Up|Removal|Number of Firms|Direct Ocean Capture", "Start-Up|Removal|Number of Firms|Ocean Alkalinity Enhancement"),
#                            labels = c("Direct Ocean Capture", "Ocean Alkalinity Enhancement")))
#   
# head(startups_df)
# summary(startups_df)



## Investment in startups
# Dollar value of investments in CDR start-ups from 2009-2023 (208 total start-ups and 511 deals that report a dollar value, bars) 
startup_investments_df <- read.csv(here::here("data/raw-data/external/State-of-Carbon-Report-2024_Chatper-3_Investment_in_CDR_start-ups.csv"))

# Format dataframe into long form
colnames(startup_investments_df)[6:20] <- gsub("X","",colnames(startup_investments_df)[6:20])
startup_investments_df <- startup_investments_df %>%
  select(-c(Model, Scenario, Region, Unit))

startup_investments_df <- startup_investments_df %>%
  filter(Variable %in% c("Start-Up|Removal|Funding|Biomass Sinking", "Start-Up|Removal|Funding|Direct Ocean Capture", "Start-Up|Removal|Funding|Ocean Alkalinity Enhancement"))

startup_investments_df <- reshape2::melt(startup_investments_df, 
                                   id.vars = c("Variable"), 
                                   variable.name = "year", 
                                   value.name = "value")
startup_investments_df$year <- as.Date(paste0(startup_investments_df$year,"-01-01"))

startup_investments_df <- startup_investments_df %>%
  mutate(Variable = factor(Variable, 
                           levels = c("Start-Up|Removal|Funding|Biomass Sinking", "Start-Up|Removal|Funding|Direct Ocean Capture", "Start-Up|Removal|Funding|Ocean Alkalinity Enhancement"),
                           labels = c("Biomass Sinking","Direct Ocean Capture", "Ocean Alkalinity Enhancement")))
  
  
head(startup_investments_df)
summary(startup_investments_df)

```




```{r Ocean Visions - N Field Trials}
mCDR_field <- readxl::read_excel(here::here("data/raw-data/external/Ocean-visions-mCDR-field-trial-database.xlsx"),sheet = "Data")

# Clean data
mCDR_field$`Start of Pilot` <- replace(mCDR_field$`Start of Pilot`, mCDR_field$`Start of Pilot` %in% c("5.12.2023","2023"),
        as.numeric(as.Date("2023-01-01")))

# Format
n_field_trials_df <- mCDR_field %>%
  filter(!is.na(`Start of Pilot`)) %>%
  group_by(`Start of Pilot`) %>%
  summarise(
    value = n()
  ) %>%
  mutate(year = as.Date(as.numeric(`Start of Pilot`), origin = "1899-12-30")) %>%
  mutate(year = ifelse(year == as.Date("1952-12-30"), as.Date("2023-01-01"), year)) %>%
  arrange(year) %>%
  mutate(year = as.Date(year, origin = as.Date("1970-01-01")))

  
summary(n_field_trials_df)

```



Source: Duarte, Carlos Manuel; Devassy, R P; Predragovic, M; Valuzzi, L; Parry, A; Hughes, Terry P (2020): Data set on restoration projects of coastal marine habitats reported worldwide [dataset]. PANGAEA, https://doi.org/10.1594/PANGAEA.912232. Accessed 24-04-2020

```{r Duarte et al 2020 - BC Restoration projects}
bc_restoration <- readxl::read_excel(here::here("data/raw-data/external/Duarte2020RestorationDataSet-1.xlsx"),
                                     sheet = "Data")

# Truncate data
bc_restoration$year <- as.Date(paste0(bc_restoration$Year, "-01-01"))
bc_restoration <- bc_restoration %>%
  filter(as.Date("1990-01-01") <= year)
```




```{r combine all mcdr plots}

# Set common date range for all plots
ylim_date <- range(c(gross_removals_df$year[gross_removals_df$ocean],
                     patents_df$year,
                     startup_investments_df$year,
                     n_field_trials_df$year,
                     oif_df$year,
                     bc_restoration$year), na.rm = TRUE)


# Gross CO2 removals
gross_removals_ggp <- gross_removals_df %>%
  filter(ocean) %>%
  group_by(year) %>%
  summarise(`Gross Removals\n(tCO2/year)` = sum(`Gross Removals\n(tCO2/year)`, na.rm=T)) %>%
  mutate(`Gross Removals\n(tCO2/year)` = cumsum(`Gross Removals\n(tCO2/year)`)) %>%
  ggplot(aes(year, `Gross Removals\n(tCO2/year)`))+
  geom_line(linewidth=1)+
  #geom_point()+
  scale_x_date(name = "Year", limits = ylim_date)+
  labs(y = "Gross Removals (tCO2/year)\n(Cumulative)")+
  theme_bw()+
  theme(
    # axis.line.x = element_blank(),
    # axis.text.x = element_blank(),
    # axis.title.x = element_blank(),
    # axis.ticks.x = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )
gross_removals_ggp

# Patents
patents_ggp <- patents_df %>%
  group_by(Variable) %>%
  arrange(year) %>%
  mutate(cum_value = cumsum(value)) %>%
  ggplot(aes(year, cum_value))+
  geom_line(aes(color = Variable), linewidth = 1)+
  labs(y = "Number of patents\n(cumulative)" 
       #caption = "Source: Ocean Visions mCDR field trials database"
       )+
  scale_x_date(limits = ylim_date)+
  scale_color_manual(values = Tol_muted[1:3])+
  theme_bw()+
  theme(
    axis.line.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )
patents_ggp


# Startup investments
startup_investments_ggp <- startup_investments_df %>%
  group_by(Variable) %>%
  arrange(year) %>%
  mutate(cum_value = cumsum(value)) %>%
  ggplot(aes(year, cum_value))+
  geom_line(aes(color = Variable), linewidth = 1)+
  labs(y = "Billion USD invested in start-ups\n(cumulative)" 
       #caption = "Source: Ocean Visions mCDR field trials database"
       )+
  scale_x_date(limits = ylim_date)+
  scale_color_manual(values = Tol_muted[1:3])+
  theme_bw()+
  theme(
    axis.line.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )
startup_investments_ggp



# Number of field trials -- 
field_trials_ggp <- n_field_trials_df %>%
  arrange(year) %>%
  mutate(cum_value = cumsum(value)) %>%
  ggplot(aes(year, cum_value))+
  geom_line(linewidth = 1)+
  labs(y = "Number of field trials\n(cumulative)" 
       #caption = "Source: Ocean Visions mCDR field trials database"
       )+
  scale_x_date(limits = ylim_date)+
  theme_bw()+
  theme(
    axis.line.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank()
  )
field_trials_ggp

ft1 <- n_field_trials_df %>%
  arrange(year) %>%
  mutate(value = cumsum(value),
         col_var = "Ocean visions field trials") %>%
  rename(x_axis = year)
ft2 <- oif_df %>%
  arrange(year) %>%
  mutate(value = cumsum(value),
         col_var = "Ocean Fertilization") %>%
  rename(x_axis = year)
  
  
field_trials_ggp2 <- my_sec_axis_lineplot(dat.prim = ft2, dat.sec = ft1,name.sec = "N of field trials\n(cumulative)", name.prim = "Fertilized area (km2)\n(cumulative)")
field_trials_ggp2 <- field_trials_ggp2 +
  scale_color_manual(values = Tol_muted[c(3,6)], 
                     breaks = c("Ocean Fertilization", "Ocean visions field trials"))+
  scale_x_date(limits = ylim_date)+
  theme_bw()+
  theme(
    axis.title.y.left = element_text(color = Tol_muted[c(3)]),
    axis.title.y.right = element_text(color = Tol_muted[c(6)]),
    axis.line.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )
field_trials_ggp2

# Number of blue carbon projects
bc_restoration_ggp <- bc_restoration %>%
  group_by(Habitat, year) %>%
  summarise(n_projects = n()) %>%
  ungroup() %>% 
  tidyr::complete(Habitat, year, fill = list(n_projects = 0)) %>%
  arrange(Habitat, year) %>%
  group_by(Habitat) %>%
  mutate(cumulative_projects = cumsum(n_projects)) %>%
  filter(Habitat != "Coral Reefs") %>%
  ggplot(aes(year, cumulative_projects, col = Habitat))+
  geom_area(position = "stack", linewidth=1, fill=NA)+
  labs(y = "Number restoration projects\n(Cumulative)", x="Year")+
  scale_x_date(limits = ylim_date)+
  theme_bw()+
  theme(
    axis.line.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank()
  )
  



## Plot together
require(egg)

mcdr_ggp <- ggarrange(
  plots = list(
    patents_ggp+ 
      theme(plot.margin=unit(c(0.1,0.5,0.5,0.1), 'cm',),
            axis.title.y = element_text(size = 10),
            legend.text = element_text(size = 6)),#+
      #guides(color = guide_legend(nrow=2)),
    startup_investments_ggp+ 
      theme(plot.margin=unit(c(0.1,0.5,0.5,0.1), 'cm'),
            axis.title.y = element_text(size = 10),
            legend.text = element_text(size = 6)),
    field_trials_ggp2+ 
      theme(plot.margin=unit(c(0.1,0.5,0.5,0.1), 'cm'),
            axis.title.y = element_text(size = 10),
            legend.text = element_text(size = 6)),
    bc_restoration_ggp+ 
      theme(plot.margin=unit(c(0.1,0.5,0.5,0.1), 'cm'),
            axis.title.y = element_text(size = 10),
            legend.text = element_text(size = 6),
            legend.key.size = unit(0.3,"cm")),
    gross_removals_ggp+ 
      theme(plot.margin=unit(c(0.1,0.5,0.5,0.1), 'cm'),
            axis.title.y = element_text(size = 10),
            legend.text = element_text(size = 6))
  ),
  nrow=5, 
  # labels = c("a. Volume indicators", 
  #            "b. Emissions indicators",
  #            "c. Efficiency indicators"
  #            ),
          #label.args = list(gp = grid::gpar(font = 4, cex = 1.2)),
          newpage = FALSE, draw=FALSE
)




ggsave(here::here("figures/2024-07-01_expert-panel-meeting/mCDR_deployment_figures.pdf"),
       mcdr_ggp, height = 12, width = 5, units = 'in')
```










